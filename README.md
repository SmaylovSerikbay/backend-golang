# Такси Приложение (Backend)

API сервер для мобильного приложения такси с поддержкой высоких нагрузок (до 1 миллиона пользователей в день).

## Особенности

- Горизонтальное масштабирование (несколько экземпляров API)
- Кэширование запросов к внешним API (2ГИС)
- Оптимизированный пул соединений с базой данных
- Метрики производительности (Prometheus и Grafana)
- Эффективное использование системных ресурсов
- Оптимизированное использование дорогостоящих внешних API

## Требования

- Docker и Docker Compose
- Go 1.21+
- PostgreSQL 13+
- Redis 6+

## Быстрый старт

1. Клонируйте репозиторий
2. Настройте файл `.env` (используйте `.env.example` как шаблон)
3. Запустите приложение:

```bash
# Дайте права на выполнение скриптам
chmod +x wait-for.sh scripts/*.sh

# Запустите с Docker Compose
docker-compose up -d
```

4. Проверьте работоспособность: `http://localhost/health`
5. Метрики доступны по адресу: `http://localhost/metrics`
6. Grafana dashboard: `http://localhost:3000` (admin/admin)

## Масштабирование

Система поддерживает горизонтальное масштабирование. Для увеличения количества экземпляров API:

```bash
# Увеличение количества реплик API
docker-compose up -d --scale api=5
```

## Оптимизация использования 2ГИС API

Система эффективно использует API 2ГИС за счет:

1. **Многоуровневого кэширования**:
   - Redis кэш для геокодирования и построения маршрутов
   - Настраиваемый TTL для разных типов запросов

2. **Ограничения скорости запросов**:
   - Настройка максимального количества запросов в день
   - Распределение запросов равномерно во времени

3. **Оптимизация маршрутов**:
   - Предрасчет и сохранение популярных маршрутов
   - Интеллектуальное кэширование на основе геохешей

## Мониторинг производительности

Система включает полноценный мониторинг:

1. **Prometheus метрики**:
   - Время ответа API
   - Количество запросов
   - Использование 2ГИС API
   - Кэш-попадания/промахи
   - Использование системных ресурсов

2. **Grafana дашборды**:
   - Общий обзор системы
   - Детальный анализ API
   - Мониторинг базы данных
   - Анализ использования внешних API

## Нагрузочное тестирование

Для нагрузочного тестирования используйте:

```bash
# Запуск нагрузочного тестирования
./scripts/load_test.sh
```

## Оптимизации для высоких нагрузок

1. **База данных**:
   - Пул соединений оптимизирован для высоких нагрузок
   - PgBouncer для connection pooling
   - Индексирование всех используемых полей

2. **Кэширование**:
   - Redis для кэширования часто запрашиваемых данных
   - LRU политика вытеснения для оптимального использования памяти

3. **API сервер**:
   - Таймауты и ограничение одновременных соединений
   - Graceful shutdown для корректного завершения работы
   - Rate limiting для защиты от перегрузок

4. **Внешние API**:
   - Умное кэширование для минимизации запросов
   - Circuit breaker для предотвращения каскадных отказов

## Цены на 2ГИС API

Обратите внимание, что 2ГИС API имеет ограничения на бесплатное использование:

- Бесплатный тариф: 500 запросов в день
- Базовый тариф: 5000 запросов в день - 15000₸/месяц
- Премиум тариф: 25000 запросов в день - 60000₸/месяц
- Корпоративный тариф: 100000 запросов в день - по запросу

Наша система оптимизирована для минимизации количества запросов при сохранении функциональности.

## Конфигурация

Основные параметры настраиваются через переменные окружения (см. `.env`):

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| DGIS_CACHE_DURATION | Время жизни кэша 2ГИС (секунды) | 86400 (1 день) |
| DGIS_DAILY_LIMIT | Дневной лимит запросов к 2ГИС API | 5000 |
| CACHE_ENABLED | Включение кэширования | true |
| DB_MAX_OPEN_CONNS | Максимальное количество открытых соединений с БД | 100 |
| DB_MAX_IDLE_CONNS | Максимальное количество простаивающих соединений с БД | 25 |
| RATE_LIMIT_PER_SECOND | Ограничение запросов в секунду | 100 |

## Масштабирование для 1 млн пользователей

При нагрузке в 1 миллион пользователей в день (примерно 12 запросов в секунду в пике) рекомендуется:

1. **Инфраструктура**:
   - 5+ экземпляров API за балансировщиком нагрузки
   - Выделенный кластер PostgreSQL с репликацией
   - Redis кластер с репликацией
   - CDN для статического контента

2. **Дополнительные оптимизации**:
   - Асинхронная обработка неважных операций через очереди сообщений
   - Географическое распределение серверов для снижения латентности
 